machine:
  node:
    version: 6

dependencies:
  cache_directories:
    - "node_modules"
    - "~/.npm"

  override:
    # Hack to use newer v. of phantom needs to update Chrome
    - sudo apt-get install libxss1 libappindicator1 libindicator7 lsb-base
    - wget https://dl.google.com/linux/direct/google-chrome-stable_current_amd64.deb
    - sudo dpkg -i google-chrome*.deb
    - npm install -g npm
    - npm install
    - sudo add-apt-repository ppa:ondrej/php -y
    - sudo apt-get update
    - sudo apt-get install curl -y
    - sudo curl -o- https://raw.githubusercontent.com/creationix/nvm/v0.31.0/install.sh | bash
    - nvm install node 6
    - sudo apt-get install php5.6 -y 
    - sudo apt-get install php5.6-mbstring php5.6-mcrypt php5.6-mysql php5.6-xml -y
    - sudo sudo a2dismod php5
    - sudo service apache2 restart
    - sudo apt-get install php5.6-xml
    - sudo curl -sS https://getcomposer.org/installer | sudo php -- --install-dir=/usr/local/bin --filename=composer

    - curl -L -o google-chrome.deb https://dl.google.com/linux/direct/google-chrome-stable_current_amd64.deb
    - sudo dpkg -i google-chrome.deb
    - sudo sed -i 's|HERE/chrome\"|HERE/chrome\" --disable-setuid-sandbox|g' /opt/google/chrome/google-chrome

    - sudo php -v
    - mysql -u ubuntu -e "create database magento"
    - sudo cp ~/clean/000-default.conf /etc/apache2/sites-available
    - sudo service apache2 restart
    - cd /home/ubuntu/clean/meh
    - composer init --no-interaction
    - cd meh
    - sudo mkdir magento2
    - sudo chmod 777 magento2
    - sudo chmod 775 /usr/local/bin
    - sudo chmod -R 777 /home/ubuntu/.composer
    - composer config -a http-basic.repo.magento.com e3fe1cabf752165bd79fbbbcb0e626fd 11543462ae0104c9792bd3d79b57663a
    - composer create-project --repository-url=https://repo.magento.com/ magento/project-community-edition=2.1.7 magento2
    - sudo composer install
    - sudo chmod -R 777 magento2
  post:
    # - npm run start-ci #  :
    # - wget https://saucelabs.com/downloads/sc-latest-linux.tar.gz
    # - tar -xzf sc-latest-linux.tar.gz

test:
  override:
   - npm test -- --runInBand
  pre:
    # - npm run test
    # - sleep 30
    # - cd sc-*-linux && ./bin/sc --user "yanns" --api-key "ac8561a1-ba7f-42c6-afd9-1dad08bac0d7" --readyfile ~/sauce_is_ready:
    #     background: true
    # # Wait for tunnel to be ready
    # - while [ ! -e ~/sauce_is_ready ]; do sleep 1; done

  post:
  - npm run start

general:
  artifacts:
    - "./reports/screenshots/"